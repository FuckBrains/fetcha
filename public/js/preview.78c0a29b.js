(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["preview"],{"19af":function(e,t,n){"use strict";var i=n("1e02"),s=n.n(i);s.a},"1e02":function(e,t,n){},3731:function(e,t,n){"use strict";var i=n("e9f4"),s=n.n(i);s.a},"3e1c":function(e,t,n){"use strict";n.r(t);var i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"page-snap-preview"},[e.work?n("div",{ref:"container",staticClass:"preview-container"},[n("div",{staticClass:"device",style:e.deviceStyle},[n("render-scene",{attrs:{variables:e.work.variables,scene:e.work.scenes[e.sceneIndex],"view-port":e.work.viewBox,"view-box":e.work.viewBox}})],1)]):e._e()])},s=[],o=n("7532"),r=n("c527"),a=n("6063"),c=n("8b3e"),l=n("b5f7"),d={name:"SnapShotPreview",components:{RenderScene:c["a"]},mixins:[r["a"],a["a"]],data(){return{sceneIndex:0,variables:[],work:null}},computed:{deviceStyle(){return{width:this.work.viewBox.width+"px",height:this.work.viewBox.height+"px"}}},created(){this.workdao=new l["a"](this.ctx,"danke/work"),this.ctx.styleRegistry=new o["a"](this.ctx)},mounted(){this.loadAndInitDevice(this.$route.params.id)},methods:{async loadAndInitDevice(e){await this.loadWork(e),this.variables=this.work.variables,this.viewPort=this.work.viewBox,this.$nextTick(()=>{const e=document.querySelectorAll("img");let t=e.length;if(0===t)window.avatarReady&&window.avatarReady();else{let n=0;for(let i of e)i.onload=function(){n++,n===t&&window.avatarReady&&window.avatarReady()}}})}}},u=d,h=(n("3731"),n("2877")),f=Object(h["a"])(u,i,s,!1,null,null,null);t["default"]=f.exports},"51b3":function(e,t,n){"use strict";n.r(t);var i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"page-slide-preview",style:e.workStyle},[e.work&&e.viewPort?n("div",{staticClass:"preview-container"},[n("div",{staticClass:"device",style:e.deviceStyle},[n("render-scene",{directives:[{name:"show",rawName:"v-show",value:!e.playing&&!e.playend,expression:"!playing && !playend"}],attrs:{scene:e.work.scenes[0],stage:"enter","view-port":e.viewPort,"view-box":e.work.viewBox}}),e._l(e.work.scenes,(function(t,i){return n("render-scene",{directives:[{name:"show",rawName:"v-show",value:t.visible,expression:"scene.visible"}],key:i,attrs:{scene:t,stage:t.stage,"view-port":e.viewPort,"view-box":e.work.viewBox}})}))],2)]):e._e(),e.work&&e.viewPort?n("div",{staticClass:"action",style:e.actionStyle},[e.currentSceneIndex>0&&!e.currentAutoPlay?n("i",{staticClass:"el-icon-right next-scene",on:{click:function(t){return e.enterScene(e.currentSceneIndex+1)}}}):e._e(),e.currentSceneIndex<e.work.scenes.length-1&&!e.currentAutoPlay?n("i",{staticClass:"el-icon-back prev-scene",on:{click:function(t){return e.enterScene(e.currentSceneIndex-1)}}}):e._e(),n("i",{staticClass:"el-icon-video-play play",on:{click:e.play}})]):e._e(),n("div",{staticClass:"seconds"},[e._v(" "+e._s(e.currentSecondsFormated)+" ")])])},s=[],o=n("7532"),r=n("2c7e"),a=n("c527"),c=n("6063"),l=n("8b3e"),d=n("b5f7"),u={name:"Preview",components:{RenderScene:l["a"]},mixins:[a["a"],c["a"]],data(){return{playing:!1,playend:!1,currentSceneIndex:0,currentSeconds:0,viewPort:null,work:null}},computed:{currentSecondsFormated(){return new Date(this.currentSeconds).toISOString().replace(/.*(\d{2}:\d{2}.\d{2}).*/,"$1")},currentAutoPlay(){return!!this.work&&this.work.scenes[this.currentSceneIndex].duration>0},workStyle(){return this.work?{background:this.work.color}:{}},actionStyle(){return this.playing?{opacity:0}:{opacity:.3}},deviceStyle(){return this.viewPort?{background:this.work.color,perspective:this.viewPort.width+"px",width:this.viewPort.width+"px",height:this.viewPort.height+"px"}:{width:"640px",height:"320px"}}},created(){this.likedao=new d["a"](this.ctx,"danke/like"),this.ctx.styleRegistry=new o["a"](this.ctx)},mounted(){let e=this.$route.query.work||this.$route.params.work;this.loadAndInitDevice(e),window.addEventListener("resize",()=>{let e=48;document.fullscreenElement?(e=0,this.isFullScreen=!0,this.currentScene=null,setTimeout(()=>{this.enterScene(0)},100)):this.isFullScreen=!1,this.viewPort=Object(r["a"])(this.work.viewBox,{width:this.$el.offsetWidth,height:this.$el.offsetHeight})},!1)},methods:{async loadAndInitDevice(e){await this.ctx.styleRegistry.loadAllFrames(),await this.loadWork(e),this.viewPort=Object(r["a"])(this.work.viewBox,{width:this.$el.offsetWidth,height:this.$el.offsetHeight}),this.work.audioUrl&&(this.audioInstance=new Audio(this.work.audioUrl),this.audioInstance.loop=!0,this.audioInstance.onloadedmetadata=()=>{},this.audioInstance.onended=()=>{},this.audioInstance.load())},play(){this.currentSeconds=0;const e=(new Date).getTime();this.updInterval=setInterval(()=>{this.currentSeconds=(new Date).getTime()-e},20),this.currentSceneIndex=0,this.enterScene(0),this.playing=!0,this.audioInstance&&(this.audioInstance.currentTime=0,this.audioInstance.play())},async enterScene(e){this.work.scenes[e].visible=!0,this.work.scenes[e].stage="enter",this.currentAutoPlay&&(this.nextInteval=setTimeout(()=>{this.currentSceneIndex<this.work.scenes.length-1?(this.currentSceneIndex++,this.leaveScene(this.currentSceneIndex-1),this.work.scenes[this.currentSceneIndex].delay?setTimeout(()=>{this.enterScene(this.currentSceneIndex)},1e3*this.work.scenes[this.currentSceneIndex].delay):this.enterScene(this.currentSceneIndex)):(this.audioInstance&&this.audioInstance.pause(),this.playing=!1,this.playend=!0)},1e3*this.work.scenes[e].duration))},async leaveScene(e){this.work.scenes[e].renderExit&&(this.work.scenes[e].stage="exit"),setTimeout(()=>{this.work.scenes[e].visible=!1},1e3*(this.work.scenes[e].exit||1))},refreshWork(){this.currentSceneIndex=0,this.enterScene(this.currentSceneIndex)},likeWork(){},enterFullScreen(){document.fullscreenElement?document.exitFullscreen&&(document.exitFullscreen(),this.isFullScreeen=!1):document.documentElement.requestFullscreen().then(()=>{this.isFullScreeen=!0})}}},h=u,f=(n("19af"),n("2877")),v=Object(f["a"])(h,i,s,!1,null,null,null);t["default"]=v.exports},6063:function(e,t,n){"use strict";var i=n("99dc");t["a"]={computed:{focusedElement(){return 1===this.selectedElements.length?this.selectedElements[0]:null},selectedElements(){return this.currentScene&&this.currentScene.elements?this.currentScene.elements.filter(e=>e.selected&&!e.locked):[]}},data(){return{}},methods:{addScene(){const e={name:"场景",id:Object(i["b"])(),elements:[],animation:{},color:"",z:100,delay:0,duration:3,exit:1};this.insertScene(e)},insertScene(e){if(this.currentScene){const t=this.work.scenes.indexOf(this.currentScene);this.work.scenes.splice(t+1,0,e)}else this.work.scenes.push(e);this.currentScene=e},chooseScene(e){this.currentScene=e},getSceneExistDuration(){let e=1;for(let t of this.currentScene.elements)if(t.style.exists)for(let n of t.style.exists){const t=n.delay+n.dura;t>e&&(e=t)}return e}}}},"896a":function(e,t,n){e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(i,s,function(t){return e[t]}.bind(null,s));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=68)}({0:function(e,t,n){"use strict";function i(e,t,n,i,s,o,r,a){var c,l="function"===typeof e?e.options:e;if(t&&(l.render=t,l.staticRenderFns=n,l._compiled=!0),i&&(l.functional=!0),o&&(l._scopeId="data-v-"+o),r?(c=function(e){e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,e||"undefined"===typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),s&&s.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(r)},l._ssrRegister=c):s&&(c=a?function(){s.call(this,this.$root.$options.shadowRoot)}:s),c)if(l.functional){l._injectStyles=c;var d=l.render;l.render=function(e,t){return c.call(t),d(e,t)}}else{var u=l.beforeCreate;l.beforeCreate=u?[].concat(u,c):[c]}return{exports:e,options:l}}n.d(t,"a",(function(){return i}))},15:function(e,t){e.exports=n("5128")},2:function(e,t){e.exports=n("5924")},41:function(e,t){e.exports=n("c56a")},68:function(e,t,n){"use strict";n.r(t);var i=n(7),s=n.n(i),o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("transition",{attrs:{name:"el-loading-fade"},on:{"after-leave":e.handleAfterLeave}},[n("div",{directives:[{name:"show",rawName:"v-show",value:e.visible,expression:"visible"}],staticClass:"el-loading-mask",class:[e.customClass,{"is-fullscreen":e.fullscreen}],style:{backgroundColor:e.background||""}},[n("div",{staticClass:"el-loading-spinner"},[e.spinner?n("i",{class:e.spinner}):n("svg",{staticClass:"circular",attrs:{viewBox:"25 25 50 50"}},[n("circle",{staticClass:"path",attrs:{cx:"50",cy:"50",r:"20",fill:"none"}})]),e.text?n("p",{staticClass:"el-loading-text"},[e._v(e._s(e.text))]):e._e()])])])},r=[];o._withStripped=!0;var a={data:function(){return{text:null,spinner:null,background:null,fullscreen:!0,visible:!1,customClass:""}},methods:{handleAfterLeave:function(){this.$emit("after-leave")},setText:function(e){this.text=e}}},c=a,l=n(0),d=Object(l["a"])(c,o,r,!1,null,null,null);d.options.__file="packages/loading/src/loading.vue";var u=d.exports,h=n(2),f=n(15),v=n(41),p=n.n(v),w=s.a.extend(u),m={install:function(e){if(!e.prototype.$isServer){var t=function(t,i){i.value?e.nextTick((function(){i.modifiers.fullscreen?(t.originalPosition=Object(h["getStyle"])(document.body,"position"),t.originalOverflow=Object(h["getStyle"])(document.body,"overflow"),t.maskStyle.zIndex=f["PopupManager"].nextZIndex(),Object(h["addClass"])(t.mask,"is-fullscreen"),n(document.body,t,i)):(Object(h["removeClass"])(t.mask,"is-fullscreen"),i.modifiers.body?(t.originalPosition=Object(h["getStyle"])(document.body,"position"),["top","left"].forEach((function(e){var n="top"===e?"scrollTop":"scrollLeft";t.maskStyle[e]=t.getBoundingClientRect()[e]+document.body[n]+document.documentElement[n]-parseInt(Object(h["getStyle"])(document.body,"margin-"+e),10)+"px"})),["height","width"].forEach((function(e){t.maskStyle[e]=t.getBoundingClientRect()[e]+"px"})),n(document.body,t,i)):(t.originalPosition=Object(h["getStyle"])(t,"position"),n(t,t,i)))})):(p()(t.instance,(function(e){if(t.instance.hiding){t.domVisible=!1;var n=i.modifiers.fullscreen||i.modifiers.body?document.body:t;Object(h["removeClass"])(n,"el-loading-parent--relative"),Object(h["removeClass"])(n,"el-loading-parent--hidden"),t.instance.hiding=!1}}),300,!0),t.instance.visible=!1,t.instance.hiding=!0)},n=function(t,n,i){n.domVisible||"none"===Object(h["getStyle"])(n,"display")||"hidden"===Object(h["getStyle"])(n,"visibility")?n.domVisible&&!0===n.instance.hiding&&(n.instance.visible=!0,n.instance.hiding=!1):(Object.keys(n.maskStyle).forEach((function(e){n.mask.style[e]=n.maskStyle[e]})),"absolute"!==n.originalPosition&&"fixed"!==n.originalPosition&&Object(h["addClass"])(t,"el-loading-parent--relative"),i.modifiers.fullscreen&&i.modifiers.lock&&Object(h["addClass"])(t,"el-loading-parent--hidden"),n.domVisible=!0,t.appendChild(n.mask),e.nextTick((function(){n.instance.hiding?n.instance.$emit("after-leave"):n.instance.visible=!0})),n.domInserted=!0)};e.directive("loading",{bind:function(e,n,i){var s=e.getAttribute("element-loading-text"),o=e.getAttribute("element-loading-spinner"),r=e.getAttribute("element-loading-background"),a=e.getAttribute("element-loading-custom-class"),c=i.context,l=new w({el:document.createElement("div"),data:{text:c&&c[s]||s,spinner:c&&c[o]||o,background:c&&c[r]||r,customClass:c&&c[a]||a,fullscreen:!!n.modifiers.fullscreen}});e.instance=l,e.mask=l.$el,e.maskStyle={},n.value&&t(e,n)},update:function(e,n){e.instance.setText(e.getAttribute("element-loading-text")),n.oldValue!==n.value&&t(e,n)},unbind:function(e,n){e.domInserted&&(e.mask&&e.mask.parentNode&&e.mask.parentNode.removeChild(e.mask),t(e,{value:!1,modifiers:n.modifiers})),e.instance&&e.instance.$destroy()}})}}},g=m,y=n(9),k=n.n(y),b=s.a.extend(u),x={text:null,fullscreen:!0,body:!1,lock:!1,customClass:""},S=void 0;b.prototype.originalPosition="",b.prototype.originalOverflow="",b.prototype.close=function(){var e=this;this.fullscreen&&(S=void 0),p()(this,(function(t){var n=e.fullscreen||e.body?document.body:e.target;Object(h["removeClass"])(n,"el-loading-parent--relative"),Object(h["removeClass"])(n,"el-loading-parent--hidden"),e.$el&&e.$el.parentNode&&e.$el.parentNode.removeChild(e.$el),e.$destroy()}),300),this.visible=!1};var O=function(e,t,n){var i={};e.fullscreen?(n.originalPosition=Object(h["getStyle"])(document.body,"position"),n.originalOverflow=Object(h["getStyle"])(document.body,"overflow"),i.zIndex=f["PopupManager"].nextZIndex()):e.body?(n.originalPosition=Object(h["getStyle"])(document.body,"position"),["top","left"].forEach((function(t){var n="top"===t?"scrollTop":"scrollLeft";i[t]=e.target.getBoundingClientRect()[t]+document.body[n]+document.documentElement[n]+"px"})),["height","width"].forEach((function(t){i[t]=e.target.getBoundingClientRect()[t]+"px"}))):n.originalPosition=Object(h["getStyle"])(t,"position"),Object.keys(i).forEach((function(e){n.$el.style[e]=i[e]}))},_=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!s.a.prototype.$isServer){if(e=k()({},x,e),"string"===typeof e.target&&(e.target=document.querySelector(e.target)),e.target=e.target||document.body,e.target!==document.body?e.fullscreen=!1:e.body=!0,e.fullscreen&&S)return S;var t=e.body?document.body:e.target,n=new b({el:document.createElement("div"),data:e});return O(e,t,n),"absolute"!==n.originalPosition&&"fixed"!==n.originalPosition&&Object(h["addClass"])(t,"el-loading-parent--relative"),e.fullscreen&&e.lock&&Object(h["addClass"])(t,"el-loading-parent--hidden"),t.appendChild(n.$el),s.a.nextTick((function(){n.visible=!0})),e.fullscreen&&(S=n),n}},C=_;t["default"]={install:function(e){e.use(g),e.prototype.$loading=C},directive:g,service:C}},7:function(e,t){e.exports=n("2b0e")},9:function(e,t){e.exports=n("7f4d")}})},"99dc":function(e,t,n){"use strict";function i(e){return new Date(1e3*e).toISOString().replace(/.*(\d{2}:\d{2}).*/,"$1")}function s(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let i=0;i<e;i++){let e=Math.round(Math.random()*(n.length-1));t+=n.substring(e,e+1)}return t}function o(e){return s(e||6)}n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return i}))},be4f:function(e,t,n){},c527:function(e,t,n){"use strict";n("0fb7"),n("450d");var i=n("f529"),s=n.n(i),o=(n("be4f"),n("896a")),r=n.n(o),a=n("99dc"),c=n("b5f7");t["a"]={props:{viewBox:{type:Object}},data(){},created(){this.workdao=new c["a"](this.ctx,"danke/work"),this.previewdao=new c["a"](this.ctx,"danke/preview"),this.styleRegistry=this.ctx.styleRegistry},methods:{slidePreview(){window.open("/slide/"+this.work.id)},newWork(e){return{id:Object(a["b"])(10),title:"我的作品",viewBox:e||{width:1080,height:1920},color:"#fff",audioUrl:"",audioName:"",audioSeconds:0,scenes:[]}},applyTicksToWork(e){this.work.audioUrl=e.url,this.work.audioName=e.name;let t=0,n=0;for(let i of this.work.scenes){if(!e.ticks[t])break;i.transitionFrame||(i.duration=e.ticks[t]-n,t++),n+=i.duration}},async loadWork(e){let t=r.a.service({fullscreen:!0,text:"加载作品中"});const n=await this.workdao.getOne(e);n.viewBox||(n.viewBox=n.screen,delete n.screen),await this.initWorkStyleResource(n);for(const i of n.scenes)i.visible=!1,i.stage="";this.work=n,t.close()},async initWorkStyleResource(e){const t=this.ctx.styleRegistry;if(e.fonts&&e.fonts.length)for(const n of e.fonts)await t.addFontFace(n);for(const n of e.scenes)for(const e of n.elements)e.animation.preview=[],e.animation.enter||(e.animation.enter=[]),e.animation.exit||(e.animation.exit=[])},initSceneSVG(e,t){for(const n of e)n.svg&&(n.content=t[n.svg]),n.mask&&(n.maskImage=t[n.mask]),n.elements&&this.initSceneSVG(n.elements,t)},getCommonResource(){const e={},t={},n={},i=new Set;for(const s of this.work.scenes)s.animation||(s.animation={}),this.assignSceneResource(s,e,n,i);return{frames:e,styles:t,svgs:n,fonts:Array.from(i)}},assignSceneResource(e,t,n,i){for(const s of e.elements)s.animation.preview=[],s.svg&&(n[s.svg]=s.content,delete s.content),s.mask&&(n[s.mask]=s.maskImage,delete s.masksvg),s.variables&&s.variables.length&&s.variables.forEach(e=>{"fontFamily"===e.type&&i.add(e.value)}),s.elements&&this.assignSceneResource(s,t,n,i)},async saveWork(){if(this.savingWork)return;this.savingWork=!0;let e=r.a.service({fullscreen:!0,text:"保存作品中"});const t=JSON.parse(JSON.stringify(this.work));if(t.author=this.ctx.user.nick,t.avatar=this.ctx.user.avatar,t.snapshot="",this.work._id)await this.workdao.patch(t.id,t);else{const e=await this.workdao.create(t);this.work._id=e.object._id,this.$router.replace("/xd?work="+this.work.id)}this.savingWork=!1,e.close(),s.a.success({message:"作品已经保存",duration:800}),this.ctx.get("/danke/preview/download?id="+t.id)},async runWork(){await this.saveWork(),window.open("/play/fit/"+this.work._id)}}}},c56a:function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!e||!t)throw new Error("instance & callback is required");var s=!1,o=function(){s||(s=!0,t&&t.apply(null,arguments))};i?e.$once("after-leave",o):e.$on("after-leave",o),setTimeout((function(){o()}),n+100)}},e9f4:function(e,t,n){}}]);